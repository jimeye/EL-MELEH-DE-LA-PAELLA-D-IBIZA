name: ğŸ”„ Maintenance Upstash & Supabase

on:
  schedule:
    # Toutes les 6 heures
    - cron: '0 */6 * * *'
  workflow_dispatch: # Permet de dÃ©clencher manuellement

jobs:
  maintain-databases:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ğŸ“¦ Install dependencies
      run: |
        echo "ğŸ“¦ Installation des dÃ©pendances..."
        npm ci
        echo "âœ… DÃ©pendances installÃ©es"
        
    - name: ğŸ” VÃ©rifier les variables d'environnement
      run: |
        echo "ğŸ” VÃ©rification des variables d'environnement..."
        echo "UPSTASH_REDIS_REST_URL: ${UPSTASH_REDIS_REST_URL:+âœ… ConfigurÃ©e}"
        echo "UPSTASH_REDIS_REST_TOKEN: ${UPSTASH_REDIS_REST_TOKEN:+âœ… ConfigurÃ©e}"
        echo "NEXT_PUBLIC_SUPABASE_URL: ${NEXT_PUBLIC_SUPABASE_URL:+âœ… ConfigurÃ©e}"
        echo "NEXT_PUBLIC_SUPABASE_ANON_KEY: ${NEXT_PUBLIC_SUPABASE_ANON_KEY:+âœ… ConfigurÃ©e}"
        
    - name: ğŸ”„ Maintain Upstash & Supabase
      env:
        UPSTASH_REDIS_REST_URL: ${{ secrets.UPSTASH_REDIS_REST_URL }}
        UPSTASH_REDIS_REST_TOKEN: ${{ secrets.UPSTASH_REDIS_REST_TOKEN }}
        NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
        NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
      run: |
        echo "ğŸš€ DÃ©marrage de la maintenance des bases de donnÃ©es..."
        echo "â° $(date)"
        
        # Utiliser le script optimisÃ© pour GitHub Actions
        node utils/github-actions-maintenance.js
        
        echo "âœ… Maintenance terminÃ©e Ã  $(date)"
        
    - name: ğŸ“Š Status Report
      if: success()
      run: |
        echo "ğŸ‰ Maintenance des bases de donnÃ©es terminÃ©e avec succÃ¨s !"
        echo "â° Prochaine maintenance dans 6 heures"
        echo "ğŸ“Š Bases maintenues actives :"
        echo "   - Upstash Redis âœ…"
        echo "   - Supabase âœ…"
        
    - name: âŒ Error Report
      if: failure()
      run: |
        echo "ğŸ’¥ La maintenance a Ã©chouÃ© !"
        echo "ğŸ“‹ VÃ©rifiez les logs ci-dessus pour plus de dÃ©tails"
        echo "ğŸ”§ Actions possibles :"
        echo "   - VÃ©rifier les variables d'environnement"
        echo "   - VÃ©rifier la connectivitÃ© rÃ©seau"
        echo "   - VÃ©rifier les permissions des bases de donnÃ©es" 